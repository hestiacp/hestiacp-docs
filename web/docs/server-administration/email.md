# Email and mail server

**TODO: Rewrite content**

## How to setup internal mail send over SMTP

Internal mail generated by Hestia (Notifications, Forgot password and update logs) are send the internal mail. If you want you can setup mail to be send over a SMTP account. In `/usr/local/hestia/install/upgrade/manual/` there is a file called `configure-server-smtp.sh` run there this script and follow the instructions.

## I am unable to send email.

Check first if the port 25 is open for outgoing traffic. A lot of providers close port 25 on default as a security measurement to combat spam.

Run the following command in command line:

```sh
telnet ASPMX.L.GOOGLE.COM 25
```

If the connection was successful you will see:

```sh
Trying 2a00:1450:400c:c00::1b...
Connected to ASPMX.L.GOOGLE.COM.
Escape character is '^]'.
220 mx.google.com ESMTP a7si1253985wrr.455 - gsmtp
```

If not, you have 2 options:

1. Contact you provider and ask them to open port 25 for outgoing traffic.
2. Setup a mail relay under the mail domain settings or set it up generally for the server in system settings. For this you to use an SMTP relay service like:
   - [Amazon SES](https://aws.amazon.com/ses/)
   - [SMTP2GO](https://www.smtp2go.com)
   - [SendinBlue](https://www.sendinblue.com)

## I am unable to receive email.

If yo are unable to receive email make sure you have setup your DNS properly. If you are using Cloudflare disable the use of the proxy for the mail.domain.com. 

When you are done you can check via [MXToolBox](https://mxtoolbox.com/MXLookup.aspx).

## How to install Rainloop

You can install Rainloop via the following command:

```sh
v-add-sys-rainloop
```

## Can I login into the backend of Rainloop

In the root folder is an file located called .rainloop containing the
username and password

```sh
Username: admin_f0e5a5aa
Password: D0ung4naLOptuaa
Secret key: admin_f0e5a5aa
```

You can access the admin via https://webmail.domain.com/?admin_f0e5a5aa

And use the data supplied above. When not needed feel free to remove
this file.

## Can I use Cloudflare Proxy with email

No Cloudflare with Proxy enabled does not work with email. If you use email hosted on you server make sure proxy for the A record is switched of mail.domain.com is switched off. Otherwise you are not able to use receive email. The following settings are suggested if you want to use Hestia as your mail server:

![DNS records](/images/mail/mail.png)

A record with name "mail" with content your server ip A record with name "webmail" with the content of your server ip MX record with name "mail" with content mail.domain.com TXT record with name "@" with the content "v=spf1 a mx ip4:your ip; \~all" TXT record with name `domainkey` with content `t=y; o=~;`` TXT record with name `mail._domainkey` with content `t=y; o=~DKIM key;`

The DKIM key and SPF record can be found via: "Mail" -\> When hovering the domain go to DNS records you will see an page with the required info

## If I send email from my server they end up in the spam folder?

Make sure you have set up the correct RDNS, SFP records and DKIM records. DKIM and SPF record can be found in "Mail" -\> When hovering the domain go to DNS records

If this doesnâ€™t work it might be possible that you ip address is on one or more black lists. You can try to unblock your self or often the easier method is to use SMTP with Amazon SES or an other SMTP provider.

## How can I enable Managesieve

During install use `--sieve` during install after that there is a an upgrade script provided in `/usr/local/hestia/install/upgrade/manual/install_sieve.sh`

## Can I allow access to Manage sieve via a external mail client

Open port 4190 in the firewall

## How can I enable manage sieve for Rainloop

Go to /etc/rainloop/data/\_data\_/\_default\_/domains and open default.ini and modify the following settings

```sh
sieve_use = On
sieve_allow_raw = Off
sieve_host = "localhost"
sieve_port = 4190
sieve_secure = "None"
```
